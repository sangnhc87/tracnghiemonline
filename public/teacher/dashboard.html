<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Gi√°o Vi√™n</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/design-system.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script defer src="/__/firebase/9.10.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/9.10.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/9.10.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, var(--gray-50), var(--primary-50));
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - reused from exam-bank */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-100);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            color: var(--gray-800);
            text-decoration: none;
            font-weight: var(--font-bold);
            font-size: var(--text-lg);
        }

        .sidebar-logo i {
            color: var(--primary-500);
            font-size: 1.5rem;
        }

        .sidebar-nav {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: var(--space-6);
        }

        .nav-section-title {
            font-size: var(--text-xs);
            font-weight: var(--font-semibold);
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 var(--space-3);
            margin-bottom: var(--space-2);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            color: var(--gray-600);
            text-decoration: none;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            transition: all var(--transition-normal);
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .nav-item.active {
            background: var(--primary-50);
            color: var(--primary-600);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--gray-100);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--gray-50);
            border-radius: var(--radius-lg);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--primary-500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-bold);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--gray-800);
        }

        .user-email {
            font-size: var(--text-xs);
            color: var(--gray-500);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Main */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: var(--space-6);
        }

        .greeting {
            margin-bottom: var(--space-6);
        }

        .greeting h1 {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--gray-800);
        }

        .greeting p {
            color: var(--gray-500);
            margin-top: var(--space-1);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue {
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .stat-icon.green {
            background: var(--success-100);
            color: var(--success-600);
        }

        .stat-icon.orange {
            background: var(--warning-100);
            color: var(--warning-600);
        }

        .stat-icon.purple {
            background: #f3e8ff;
            color: #9333ea;
        }

        .stat-value {
            font-size: var(--text-2xl);
            font-weight: var(--font-bold);
            color: var(--gray-800);
        }

        .stat-label {
            font-size: var(--text-sm);
            color: var(--gray-500);
        }

        /* Quick Actions */
        .section {
            margin-bottom: var(--space-6);
        }

        .section-title {
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--gray-800);
            margin-bottom: var(--space-4);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-3);
        }

        .quick-action {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            text-align: center;
            text-decoration: none;
            transition: all var(--transition-normal);
        }

        .quick-action:hover {
            border-color: var(--primary-300);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .quick-action i {
            font-size: 2rem;
            color: var(--primary-500);
            margin-bottom: var(--space-3);
            display: block;
        }

        .quick-action span {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--gray-700);
        }

        /* Recent Items */
        .recent-card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        .recent-header {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recent-list {
            padding: var(--space-2);
        }

        .recent-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            transition: background var(--transition-fast);
        }

        .recent-item:hover {
            background: var(--gray-50);
        }

        .recent-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
        }

        .recent-info {
            flex: 1;
        }

        .recent-title {
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--gray-800);
        }

        .recent-meta {
            font-size: var(--text-xs);
            color: var(--gray-500);
        }

        .pending-alert {
            background: var(--warning-50);
            border: 1px solid var(--warning-200);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .pending-alert i {
            font-size: 2rem;
            color: var(--warning-500);
        }

        .pending-alert-content {
            flex: 1;
        }

        .pending-alert-title {
            font-weight: var(--font-semibold);
            color: var(--warning-800);
        }

        .pending-alert-text {
            font-size: var(--text-sm);
            color: var(--warning-700);
            margin-top: var(--space-1);
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>Quiz Online</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">T·ªïng quan</div>
                    <a href="/teacher/dashboard.html" class="nav-item active">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                    <a href="/teacher/exam-bank.html" class="nav-item">
                        <i class="fas fa-file-alt"></i> Kho ƒê·ªÅ Thi
                    </a>
                    <a href="/" class="nav-item">
                        <i class="fas fa-users"></i> Qu·∫£n l√Ω L·ªõp
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">C√¥ng c·ª•</div>
                    <a href="/editor_V3.html" class="nav-item">
                        <i class="fas fa-wand-magic-sparkles"></i> So·∫°n Word Pro
                    </a>
                    <a href="/soan_latex_pro.html" class="nav-item">
                        <i class="fas fa-superscript"></i> So·∫°n LaTeX
                    </a>
                    <a href="/code-bank.html" class="nav-item">
                        <i class="fas fa-code"></i> Kho M√£ Code
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Th·ªëng k√™</div>
                    <a href="/stats.html" class="nav-item">
                        <i class="fas fa-chart-line"></i> B√°o c√°o
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="user-avatar">G</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Gi√°o vi√™n</div>
                        <div class="user-email" id="user-email">email@example.com</div>
                    </div>
                    <button class="btn btn-ghost btn-icon" id="logout-btn" title="ƒêƒÉng xu·∫•t">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Pending Alert (shown only for pending users) -->
            <div class="pending-alert" id="pending-alert" style="display:none;">
                <i class="fas fa-hourglass-half"></i>
                <div class="pending-alert-content">
                    <div class="pending-alert-title">T√†i kho·∫£n ƒëang ch·ªù duy·ªát</div>
                    <div class="pending-alert-text">Y√™u c·∫ßu ƒëƒÉng k√Ω c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c xem x√©t. Vui l√≤ng ƒë·ª£i Admin duy·ªát
                        t√†i kho·∫£n.</div>
                </div>
            </div>

            <div class="greeting">
                <h1>Xin ch√†o, <span id="greeting-name">Gi√°o vi√™n</span>! üëã</h1>
                <p>ƒê√¢y l√† t·ªïng quan ho·∫°t ƒë·ªông c·ªßa b·∫°n</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue"><i class="fas fa-file-alt"></i></div>
                    <div>
                        <div class="stat-value" id="total-exams">0</div>
                        <div class="stat-label">ƒê·ªÅ thi</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green"><i class="fas fa-users"></i></div>
                    <div>
                        <div class="stat-value" id="total-classes">0</div>
                        <div class="stat-label">L·ªõp h·ªçc</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange"><i class="fas fa-paper-plane"></i></div>
                    <div>
                        <div class="stat-value" id="total-submissions">0</div>
                        <div class="stat-label">B√†i n·ªôp</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon purple"><i class="fas fa-calendar"></i></div>
                    <div>
                        <div class="stat-value" id="subscription-days">0</div>
                        <div class="stat-label">Ng√†y c√≤n l·∫°i</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Thao t√°c nhanh</h2>
                <div class="quick-actions">
                    <a href="/" class="quick-action">
                        <i class="fas fa-plus-circle"></i>
                        <span>Th√™m ƒë·ªÅ thi</span>
                    </a>
                    <a href="/teacher/exam-bank.html" class="quick-action">
                        <i class="fas fa-folder-open"></i>
                        <span>Kho ƒë·ªÅ thi</span>
                    </a>
                    <a href="/editor_V3.html" class="quick-action">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>So·∫°n Word Pro</span>
                    </a>
                    <a href="/stats.html" class="quick-action">
                        <i class="fas fa-chart-line"></i>
                        <span>Xem th·ªëng k√™</span>
                    </a>
                </div>
            </div>

            <div class="section">
                <div class="recent-card">
                    <div class="recent-header">
                        <h3 class="section-title" style="margin:0;">B√†i n·ªôp g·∫ßn ƒë√¢y</h3>
                        <a href="/stats.html" class="btn btn-ghost btn-sm">Xem t·∫•t c·∫£</a>
                    </div>
                    <div class="recent-list" id="recent-submissions">
                        <div class="recent-item">
                            <div class="recent-icon"><i class="fas fa-spinner fa-spin"></i></div>
                            <div class="recent-info">
                                <div class="recent-title">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let db, auth, currentUser, userData;

            const initApp = setInterval(() => {
                if (typeof firebase !== 'undefined' && firebase.apps.length) {
                    clearInterval(initApp);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    setupAuth();
                }
            }, 100);

            function setupAuth() {
                document.getElementById('logout-btn').onclick = () => auth.signOut().then(() => location.href = '/');

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('user-name').textContent = user.displayName || 'Gi√°o vi√™n';
                        document.getElementById('user-email').textContent = user.email;
                        document.getElementById('user-avatar').textContent = (user.displayName || user.email)[0].toUpperCase();
                        document.getElementById('greeting-name').textContent = user.displayName?.split(' ').pop() || 'Gi√°o vi√™n';

                        // Check user status
                        await checkUserStatus();
                        await loadStats();
                        await loadRecentSubmissions();
                    } else {
                        location.href = '/';
                    }
                });
            }

            async function checkUserStatus() {
                try {
                    const doc = await db.collection('users').doc(currentUser.uid).get();
                    if (doc.exists) {
                        userData = doc.data();
                        const status = userData.status || 'pending';

                        if (status !== 'approved') {
                            document.getElementById('pending-alert').style.display = 'flex';
                        }

                        document.getElementById('subscription-days').textContent = userData.subscriptionDays || 0;
                    }
                } catch (e) {
                    console.error('Check status error:', e);
                }
            }

            async function loadStats() {
                try {
                    // Query exams and classes from root collections with teacherId filter
                    const [exams, classes] = await Promise.all([
                        db.collection('exams').where('teacherId', '==', currentUser.uid).get(),
                        db.collection('classes').where('teacherId', '==', currentUser.uid).get()
                    ]);

                    document.getElementById('total-exams').textContent = exams.size;
                    document.getElementById('total-classes').textContent = classes.size;

                    // Count submissions from submissions collection
                    const submissions = await db.collection('submissions').where('teacherId', '==', currentUser.uid).get();
                    document.getElementById('total-submissions').textContent = submissions.size;
                } catch (e) {
                    console.error('Load stats error:', e);
                }
            }

            async function loadRecentSubmissions() {
                try {
                    // Query submissions from root collection
                    const submissions = await db.collection('submissions')
                        .where('teacherId', '==', currentUser.uid)
                        .orderBy('submittedAt', 'desc')
                        .limit(5)
                        .get();

                    const container = document.getElementById('recent-submissions');
                    if (submissions.empty) {
                        container.innerHTML = `<div class="recent-item"><div class="recent-icon"><i class="fas fa-inbox"></i></div><div class="recent-info"><div class="recent-title" style="color:var(--gray-500);">Ch∆∞a c√≥ b√†i n·ªôp</div></div></div>`;
                        return;
                    }

                    container.innerHTML = submissions.docs.map(doc => {
                        const s = doc.data();
                        const time = s.submittedAt?.toDate?.()?.toLocaleString('vi-VN') || 'N/A';
                        return `
                    <div class="recent-item">
                        <div class="recent-icon" style="background:var(--success-100);color:var(--success-600);">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="recent-info">
                            <div class="recent-title">${s.studentName || 'H·ªçc sinh'} - ${s.className || 'L·ªõp'}</div>
                            <div class="recent-meta">ƒê·ªÅ ${s.examCode || 'N/A'} ‚Ä¢ ${s.score?.toFixed(1) || 0} ƒëi·ªÉm ‚Ä¢ ${time}</div>
                        </div>
                    </div>`;
                    }).join('');
                } catch (e) {
                    console.error('Load submissions error:', e);
                    document.getElementById('recent-submissions').innerHTML = `<div class="recent-item"><div class="recent-info"><div class="recent-title" style="color:var(--danger-500);">L·ªói t·∫£i d·ªØ li·ªáu</div></div></div>`;
                }
            }
        });
    </script>
</body>

</html>